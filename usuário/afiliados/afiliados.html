<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Afiliados - SLICED</title>
    <link rel="icon" href="/imgs/LOGO-SLICED.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../../controle-dados/balance-widget.css">
    <link rel="stylesheet" href="afiliados.css">
</head>

<body>
    <!-- Part√≠culas de fundo -->
    <div class="particles" id="particles"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-logo">
            <img src="/imgs/LOGO-SLICED.png" alt="SLICED Logo">
            <h1>SLICED</h1>
        </div>
        <div class="header-user">
            <div class="user-info">
                <div class="user-name" id="userName">Carregando...</div>
                <div class="user-email" id="userEmail"></div>
            </div>
            <button class="btn-logout" id="btnLogout">Sair</button>
        </div>
    </header>

    <!-- Widget de Saldo -->
    <div id="balance-widget" class="balance-widget"></div>

    <div class="main-container">
        <div class="affiliates-hero">
            <h2 class="hero-title">Programa de Afiliados</h2>
            <p class="hero-text">
                Convide amigos e influencers para fazer parte da SLICED e ganhe benef√≠cios exclusivos.
                A cada novo s√≥cio indicado, voc√™ acumula dinheiro na sua conta assim podendo sacar.
            </p>
            <div class="commission-info"
                style="background: rgba(76, 175, 80, 0.15); border-left: 4px solid #4CAF50; padding: 15px; margin: 20px 0; border-radius: 8px;">
                <p style="margin: 0; color: #4CAF50; font-weight: 600; font-size: 1.1em;">
                    üí∞ Comiss√£o de Afiliado: A cada R$ 10,00 de indica√ß√£o, voc√™ recebe R$ 0,50!
                </p>
            </div>
            <div class="withdrawal-info"
                style="background: rgba(33, 150, 243, 0.15); border-left: 4px solid #2196F3; padding: 15px; margin: 20px 0; border-radius: 8px;">
                <p style="margin: 0; color: #2196F3; font-weight: 600; font-size: 1.1em;">
                    üí≥ Saque Dispon√≠vel: Voc√™ poder√° sacar quando tiver R$ 20,00 no saldo de indica√ß√£o!
                </p>
            </div>

            <div class="referral-box">
                <label class="referral-label">Seu Link Exclusivo</label>
                <div class="referral-input-group">
                    <input type="text" class="referral-input" value="spfc.com.br/convite/sliced123" readonly
                        id="referralLink">
                    <button class="btn-copy" onclick="copyLink()">Copiar Link</button>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Indica√ß√µes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">R$ 0,00</div>
                <div class="stat-label">Ganhos Totais</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Pontos Acumulados</div>
            </div>
        </div>

        <!-- Card de Saldo de Afiliado -->
        <div class="affiliate-balance-card">
            <div class="balance-header">
                <h3><i class="material-icons">account_balance_wallet</i> Saldo de Afiliado</h3>
            </div>
            <div class="balance-amount" id="affiliateBalance">R$ 0,00</div>
            <p class="balance-description">Comiss√µes acumuladas das suas indica√ß√µes</p>
            <button class="btn-withdraw-affiliate" id="btnWithdrawAffiliate" disabled>
                <i class="material-icons">payments</i>
                Solicitar Saque (m√≠n. R$ 20,00)
            </button>
        </div>
    </div>

    <!-- Modal de Saque de Afiliado -->
    <div id="withdrawAffiliateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="material-icons">remove_circle</i> Solicitar Saque de Afiliado</h3>
                <button class="modal-close" id="closeWithdrawModal">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-description">Seu saldo de afiliado atual: <strong id="modalAffiliateBalance">R$ 0,00</strong></p>
                
                <form id="withdrawAffiliateForm">
                    <div class="form-group">
                        <label for="withdrawAmount">Valor do Saque (R$)</label>
                        <input type="number" id="withdrawAmount" min="20" step="0.01" required placeholder="M√≠nimo: R$ 20,00">
                        <small style="display: block; margin-top: 8px; color: rgba(255, 255, 255, 0.6); font-size: 0.85rem;">
                            Valor m√≠nimo: R$ 20,00
                        </small>
                    </div>

                    <div class="withdraw-info">
                        <i class="material-icons">schedule</i>
                        <p>O saque ser√° processado em at√© 24 horas √∫teis.</p>
                    </div>

                    <button type="submit" class="btn btn-primary" id="btnConfirmWithdraw">
                        <i class="material-icons">check_circle</i>
                        Confirmar Saque
                    </button>
                </form>

                <div id="withdrawLoading" class="modal-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Processando solicita√ß√£o...</p>
                </div>

                <div id="withdrawSuccess" class="success-message" style="display: none;">
                    <i class="material-icons">check_circle</i>
                    <p>Saque solicitado com sucesso!</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom Navbar -->
    <nav class="bottom-navbar">
        <a href="../inicio/inicio.html" class="nav-item">
            <i class="material-icons">home</i>
            <span>In√≠cio</span>
        </a>
        <a href="../termos/termos.html" class="nav-item">
            <i class="material-icons">description</i>
            <span>Termos</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="material-icons">group_add</i>
            <span>Afiliados</span>
        </a>
        <a href="/usu√°rio/vakinha/vakinha.html" class="nav-item">
            <i class="material-icons">favorite</i>
            <span>Vakinha</span>
        </a>
        <a href="../anuncie/anuncie.html" class="nav-item">
            <i class="material-icons">campaign</i>
            <span>Anuncie</span>
        </a>
        <a href="../perfil/perfil.html" class="nav-item">
            <i class="material-icons">person</i>
            <span>Perfil</span>
        </a>
    </nav>

    <script type="module">
        import { iniciarRastreamentoGlobal } from '../../controle-dados/tracker-config.js';
        import { initBalanceWidget } from '../../controle-dados/balance-widget.js';

        // Importar Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD85kB-ZjHINwOlIAUShW0lCQOBZQH7LLQ",
            authDomain: "spfc-jogo.firebaseapp.com",
            projectId: "spfc-jogo",
            storageBucket: "spfc-jogo.firebasestorage.app",
            messagingSenderId: "71353090673",
            appId: "1:71353090673:web:4754e0c6ef96e4e9d2a9f3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUserData = null;
        let currentAffiliateBalance = 0;

        // Inicializar rastreamento
        iniciarRastreamentoGlobal({
            onUserLoaded: async (dados, user) => {
                currentUserData = { ...dados, uid: user.uid };
                
                // Atualizar dados na tela
                document.getElementById('userName').textContent = dados.nomeCompleto;
                document.getElementById('userEmail').textContent = dados.email;

                // Inicializar widget de saldo
                if (user && user.uid) {
                    await initBalanceWidget(user.uid);
                }

                // Gerar link de afiliado baseado no ID (dados.uid vem do Firestore)
                const userIdShort = dados.uid.substring(0, 8);
                document.getElementById('referralLink').value = `sliced.com.br/convite/${userIdShort}`;

                // Carregar saldo de afiliado
                await loadAffiliateBalance(user.uid);
            },
            onLogout: () => {
                window.location.href = '../../login/login.html';
            }
        });

        // Carregar saldo de afiliado do Firebase
        async function loadAffiliateBalance(uid) {
            try {
                const userRef = doc(db, 'SLICED', 'data', 'Usu√°rio', uid);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    currentAffiliateBalance = userData['afiliado-saldo'] || 0;
                    
                    // Atualizar UI
                    const balanceFormatted = currentAffiliateBalance.toLocaleString('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    });
                    
                    document.getElementById('affiliateBalance').textContent = balanceFormatted;
                    document.getElementById('modalAffiliateBalance').textContent = balanceFormatted;

                    // Habilitar/desabilitar bot√£o de saque
                    const btnWithdraw = document.getElementById('btnWithdrawAffiliate');
                    if (currentAffiliateBalance >= 20) {
                        btnWithdraw.disabled = false;
                    } else {
                        btnWithdraw.disabled = true;
                    }
                } else {
                    // Se n√£o existir, criar com saldo 0
                    await setDoc(userRef, {
                        'afiliado-saldo': 0
                    }, { merge: true });
                }
            } catch (error) {
                console.error('Erro ao carregar saldo de afiliado:', error);
            }
        }

        // Elementos do DOM
        const modal = document.getElementById('withdrawAffiliateModal');
        const btnOpenModal = document.getElementById('btnWithdrawAffiliate');
        const btnCloseModal = document.getElementById('closeWithdrawModal');
        const withdrawForm = document.getElementById('withdrawAffiliateForm');
        const withdrawLoading = document.getElementById('withdrawLoading');
        const withdrawSuccess = document.getElementById('withdrawSuccess');

        // Abrir modal
        btnOpenModal.addEventListener('click', () => {
            modal.classList.add('show');
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawAmount').max = currentAffiliateBalance;
        });

        // Fechar modal
        btnCloseModal.addEventListener('click', () => {
            modal.classList.remove('show');
            withdrawForm.reset();
            withdrawLoading.style.display = 'none';
            withdrawSuccess.style.display = 'none';
            withdrawForm.style.display = 'block';
        });

        // Fechar modal clicando fora
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                btnCloseModal.click();
            }
        });

        // Processar solicita√ß√£o de saque
        withdrawForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('withdrawAmount').value);

            // Valida√ß√µes
            if (amount < 20) {
                alert('O valor m√≠nimo para saque √© R$ 20,00');
                return;
            }

            if (amount > currentAffiliateBalance) {
                alert('Saldo insuficiente');
                return;
            }

            if (!currentUserData) {
                alert('Erro: Usu√°rio n√£o identificado');
                return;
            }

            try {
                // Mostrar loading
                withdrawForm.style.display = 'none';
                withdrawLoading.style.display = 'block';

                // Salvar solicita√ß√£o de saque no Firestore
                const withdrawRef = collection(db, 'SLICED', 'data', 'Saques-Afiliado');
                await addDoc(withdrawRef, {
                    userId: currentUserData.uid,
                    userName: currentUserData.nomeCompleto,
                    userEmail: currentUserData.email,
                    amount: amount,
                    status: 'pendente',
                    requestDate: new Date().toISOString(),
                    processedDate: null
                });

                // Atualizar saldo do usu√°rio (deduzir o valor solicitado)
                const userRef = doc(db, 'SLICED', 'data', 'Usu√°rio', currentUserData.uid);
                const newBalance = currentAffiliateBalance - amount;
                await updateDoc(userRef, {
                    'afiliado-saldo': newBalance
                });

                // Atualizar saldo local
                currentAffiliateBalance = newBalance;

                // Mostrar sucesso
                withdrawLoading.style.display = 'none';
                withdrawSuccess.style.display = 'flex';

                // Recarregar saldo na UI
                await loadAffiliateBalance(currentUserData.uid);

                // Fechar modal ap√≥s 3 segundos
                setTimeout(() => {
                    btnCloseModal.click();
                }, 3000);

            } catch (error) {
                console.error('Erro ao processar saque:', error);
                alert('Erro ao processar solicita√ß√£o de saque. Tente novamente.');
                withdrawLoading.style.display = 'none';
                withdrawForm.style.display = 'block';
            }
        });

        // Part√≠culas
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 8 + 's';
            particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
            particlesContainer.appendChild(particle);
        }

        // Copy Link Function
        window.copyLink = function () {
            const copyText = document.getElementById("referralLink");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);

            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerText;
            btn.innerText = 'Copiado!';
            btn.style.background = '#4CAF50';

            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.background = '';
            }, 2000);
        }
    </script>
</body>

</html>